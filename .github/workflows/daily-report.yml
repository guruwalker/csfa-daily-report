name: Daily CSFA Report

on:
  # Run at 7 PM East Africa Time (4 PM UTC) on weekdays
  schedule:
    - cron: '0 16 * * 1-5'  # Mon-Fri at 4 PM UTC (7 PM EAT)

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      send_email:
        description: 'Send email report?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run token diagnostic (debug only)
        if: runner.debug == '1'
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          LARAVEL_TOKEN: ${{ secrets.LARAVEL_TOKEN }}
          SAT_SESSION: ${{ secrets.SAT_SESSION }}
          XSRF_TOKEN: ${{ secrets.XSRF_TOKEN }}
        run: |
          python token_diagnostic.py

      - name: Generate CSFA Report
        env:
          # API Authentication
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          LARAVEL_TOKEN: ${{ secrets.LARAVEL_TOKEN }}
          SAT_SESSION: ${{ secrets.SAT_SESSION }}
          XSRF_TOKEN: ${{ secrets.XSRF_TOKEN }}
          SAT_USER_ID: ${{ secrets.SAT_USER_ID }}

          # API Configuration
          HOST: tintasberger.solutechlabs.com
          COUNTRY_ID: 149

          # Email Configuration
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          SENDER_NAME: ${{ secrets.SENDER_NAME }}
          RECIPIENT_NAME: ${{ secrets.RECIPIENT_NAME }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_CC: ${{ secrets.EMAIL_CC }}
          EMAIL_SUBJECT: "Tintas Berger CSFA Report - {date}"

          # Report Configuration
          REPORT_CURRENCY: MZN
          OUTPUT_FILE: Daily_CSFA_Report.xlsx
          SEND_EMAIL: ${{ github.event.inputs.send_email || 'true' }}

          # Logging
          LOG_LEVEL: INFO
          LOG_FILE: report_generation.log

          # Execution Mode
          RUN_MODE: once
        run: |
          echo "üöÄ Starting CSFA report generation..."
          python main.py

          if [ $? -eq 0 ]; then
            echo "‚úÖ Report generation successful!"
          else
            echo "‚ùå Report generation failed!"
            exit 1
          fi

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: csfa-report-${{ github.run_number }}
          path: |
            Daily_CSFA_Report.xlsx
            summary_for_email.txt
            report_generation.log
          retention-days: 30

      - name: Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_number }}
          path: |
            report_generation.log
            *.log
          retention-days: 7

      - name: Send Failure Notification
        if: failure()
        run: |
          echo "‚ùå Report generation failed!"
          echo "Check the logs above for details"
